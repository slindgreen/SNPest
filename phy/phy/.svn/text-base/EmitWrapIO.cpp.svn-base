#include "phy/EmitWrapIO.h"

namespace phy {

  // global tree string (used by overloaded version of readEmitWrappers)
  string globalTreeString = ""; 

  // example:
  // KIND:	phylo
  // NAME:	single
  // TYPE:	single
  // FILE:	sngNucPhyloModel.v3.txt

  void readEmitWrappers(istream & str, EmitWrappers & ew, string const & filePrefix)
  {
    skipWhiteSpaceAndComments(str);
    // modelCount
    unsigned modelCount;
    getFeature(str, "EMIT_MODEL_COUNT:", modelCount);

    // reading the models
    skipWhiteSpaceAndComments(str);
    //while ( str.good() ) {
    for (unsigned i = 0; i < modelCount; i++) {
      string kind, name, type, file;
      unsigned minDist = 1; // define default value
      unsigned tagCount = 0;
      while ( moreTags(str) ) {
	string tag;
	str >> tag;
	if (tag == "KIND:")
	  str >> kind;
	else if (tag == "TYPE:")
	  str >> type;
	else if (tag == "NAME:")
	  str >> name;
	else if (tag == "FILE:")
	  str >> file;
	else if (tag == "MIN_DIST:")
	  str >> minDist;
	else
	  errorAbort("Unknown tag ('" + tag + "') in emitWrapper (emitModel) with name  '" + name + "'.");
	skipLine(str); // skip rest of line
	tagCount++;
      }
      if (tagCount < 4) 
	errorAbort("emitWrapper (emitModel) with name  '" + name + "' has wrong number of tags.");
	
      // check type
      if (type != "single" and type != "pair")
	errorAbort("from operator>> for EmitWrapper: emit model with name '" + name +"' has type '" + type + "'. the type must be either 'single' or 'pair'.");

      // mk wrapper
      if (kind == "phylo") { 
	PhyloTree phyloTree = readPhyloTree(filePrefix + file, globalTreeString);
	if (type == "single") {
	  EmitWrappers::VectorEmitWrapPtr_t ptr = boost::shared_ptr<PhyloVectorWrap>(new PhyloVectorWrap(name, phyloTree) );
	  ew.addVectorEmitWrap(ptr);
	}
	else if (type == "pair") {
	  EmitWrappers::MatrixEmitWrapPtr_t ptr = boost::shared_ptr<PhyloMatrixWrap>(new PhyloMatrixWrap(name, minDist, phyloTree) );
	  ew.addMatrixEmitWrap(ptr);
	}
      }
      else // kind not phylo
	errorAbort("from operator>> for EmitWrapper: emit model with name '" + name +"' is of kind '" + kind + "', which is currently not implemented");
      skipWhiteSpaceAndComments(str);
    }
  }


  void readEmitWrappers(string const & file, EmitWrappers & ew)
  {
    string filePrefix = pathPrefix(file);
    ifstream f;
    openInFile(f, file);
    readEmitWrappers(f, ew, filePrefix);
  }


  EmitWrappers readEmitWrappers(string const & file)
  {
    EmitWrappers ew;
    readEmitWrappers(file, ew);
    return ew;
  }

  void readEmitWrappers(string const & file, EmitWrappers & ew, string const & treeString)
  {
    globalTreeString = treeString;
    readEmitWrappers(file, ew);
    globalTreeString = "";
  }

  EmitWrappers readEmitWrappers(string const & file, string const & treeString)
  {
    EmitWrappers ew;
    readEmitWrappers(file, ew, treeString);
    return ew;
  }


} // Namespace phy 


